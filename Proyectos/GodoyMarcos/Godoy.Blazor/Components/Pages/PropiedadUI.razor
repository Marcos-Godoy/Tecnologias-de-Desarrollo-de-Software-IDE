@page "/propiedad"
@page "/propiedad/{idPropiedad:int}"
@rendermode InteractiveServer

@inject NavigationManager navegacion;
@inject IJSRuntime JSRuntime

<h2 class="mt-3">@titulo</h2>

@if (!errorBD)
{
    <div class="mt-4">
        <label class="form-label fw-bold">Tipo de Propiedad</label>
        <InputSelect class="form-select" @bind-Value="propiedad.IdTipoPropiedad">
            @foreach (var tipoPropiedad in tiposPropiedades)
            {
                <option value="@tipoPropiedad.Id">@tipoPropiedad.Descripcion</option>
            }
        </InputSelect>
    </div>

    <div class="mt-4">
        <label class="form-label fw-bold">Titulo</label>
        <InputText class="form-control" @bind-Value="propiedad.Titulo"></InputText>
    </div>

    <div class="mt-4">
        <label class="form-label fw-bold">Descripcion</label>
        <InputText class="form-control" @bind-Value="propiedad.Descripcion"></InputText>
    </div>

    <div class="mt-4">
        <label class="form-label fw-bold">Habitaciones</label>
        <InputNumber class="form-control" @bind-Value="propiedad.CantidadHabitaciones"></InputNumber>
    </div>

    <div class="mt-4">
        <label class="form-label fw-bold">Metros Cuadrados</label>
        <InputNumber class="form-control" @bind-Value="propiedad.M2"></InputNumber>
    </div>

    <div class="mt-4">
        <label class="form-label fw-bold">Precio</label>
        <InputNumber class="form-control" @bind-Value="propiedad.Precio"></InputNumber>
    </div>

    <div class="mt-4">
        <label class="form-label fw-bold">Fecha de Alta</label>
        <InputDate class="form-control" @bind-Value="propiedad.FechaAlta" readonly disabled></InputDate>
    </div>

    <div class="d-flex align-items-center justify-content-end mt-3">
        <a class="btn btn-warning" href="propiedades">Volver</a>

        <button class="btn btn-primary ms-2" type="submit" @onclick="Submit">
            @btnTexto
        </button>
    </div>
}
else
{
    <div class="alert alert-danger fw-bold my-4" role="alert">
        Error al conectarse a la base de datos!
    </div>
    <div class="d-flex justify-content-end">
        <a class="btn btn-warning" href="propiedades">Volver</a>
    </div>
}


@code {
    [Parameter]
    public int idPropiedad { get; set; } = 0;

    string titulo = string.Empty;
    string btnTexto = string.Empty;

    [SupplyParameterFromForm]
    private Propiedad propiedad { get; set; } = new Propiedad();
    List<TipoPropiedad> tiposPropiedades = new List<TipoPropiedad>();

    bool errorBD = false;

    protected override async Task OnInitializedAsync()
    {
        if (idPropiedad != 0)
        {
            titulo = "Editar Propiedad";
            btnTexto = "Actualizar";
            try
            {
                propiedad = await PropiedadApiClient.GetAsync(idPropiedad);
                tiposPropiedades = (List<TipoPropiedad>)await TipoPropiedadApiClient.GetAllAsync();
            }
            catch (Exception)
            {
                errorBD = true;
            }
        }
        else
        {
            titulo = "Nueva Propiedad";
            btnTexto = "Guardar";
            try
            {
                tiposPropiedades = (List<TipoPropiedad>)await TipoPropiedadApiClient.GetAllAsync();
            }
            catch (Exception)
            {
                errorBD = true;
            }
        }
    }

    private async void Submit()
    {
        if (this.Validar() == "")
        {
            if (idPropiedad != 0)
            {
                var confirm = await JSRuntime.InvokeAsync<bool>("confirm", $"¿Estás seguro de que deseas modificar?");
                if (confirm)
                {
                    await PropiedadApiClient.UpdateAsync(propiedad);
                    navegacion.NavigateTo("/propiedades");
                }
            }
            else
            {
                var confirm = await JSRuntime.InvokeAsync<bool>("confirm", $"¿Estás seguro de que deseas agregar?");
                if (confirm)
                {
                    propiedad.FechaAlta = DateTime.Now;
                    await PropiedadApiClient.AddAsync(propiedad);
                    navegacion.NavigateTo("/propiedades");
                }
            }
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", this.Validar());
        }
    }

    private string Validar()
    {
        if (propiedad.Titulo.Length > 50)
        {
            return "El titulo debe tener menos de 50 caracteres.";
        }
        if (propiedad.CantidadHabitaciones < 0 || propiedad.CantidadHabitaciones > 10)
        {
            return "La cantidad de habitaciones debe estar entre 0 y 10";
        }
        if (propiedad.Descripcion == string.Empty)
        {
            return "La descripcion no puede estar vacia.";
        }
        return "";
    }
}